#!/usr/bin/env bats
source functions.sh

readonly TARGET_COMMAND="../bin/unko.any"
readonly BASH_REQUIRE_VERSION=4.0

#==============================================================================
# NOTE:
#   echo-sdã¯Bash4.0ä»¥ä¸‹ã§ã¯å‹•ã‹ãªã„ãŸã‚ã€Bash4.1ä»¥ä¸Šã®ã¿ãƒ†ã‚¹ãƒˆã™ã‚‹
#==============================================================================

bash_version=$(bash --version | grep -Eo "[0-9]+\.[0-9]+" | head -n 1)
if [ $(echo "$BASH_REQUIRE_VERSION < $bash_version" | bc) -eq 0 ]; then
  echo "  Bash${BASH_REQUIRE_VERSION}ä»¥ä¸‹ã¯ã‚¹ã‚­ãƒƒãƒ—"
  exit 0
fi

@test 'å¼•æ•°ãŒãªã„å ´åˆã¯ãƒ˜ãƒ«ãƒ—ã‚’å‡ºåŠ›ã™ã‚‹' {
  run "$TARGET_COMMAND"
  [ "$status" -eq 0 ]
  coverage "$TARGET_COMMAND"
}

@test 'å¼•æ•°ãŒ1ã¤ã®ã¨ãã¯ğŸ’©ã®ç½®æ›ã®ã¿' {
  run "$TARGET_COMMAND" ã‚
  [ "$status" -eq 0 ]
  [ "${lines[0]}" = "ï¼¿äººäººäººäººäººäººï¼¿" ]
  [ "${lines[1]}" = "ï¼ã€€çªç„¶ã®æ­»ã€€ï¼œ" ]
  [ "${lines[2]}" = "ï¿£Y^Y^Y^Y^Y^Y^ï¿£" ]
  [ "${lines[3]}" = "ã€€ã€€ã€€ã€€ã€€ã€€ğŸ‘‘" ]
  [ "${lines[4]}" = "ã€€ã€€ã€€ã€€ï¼ˆã‚ã‚ã‚ï¼‰" ]
  [ "${lines[5]}" = "ã€€ã€€ã€€ï¼ˆã‚ğŸ‘ã‚ğŸ‘ã‚ï¼‰" ]
  [ "${lines[6]}" = "ã€€ã€€ï¼ˆã‚ã‚ã‚ğŸ‘ƒã‚ã‚ã‚ï¼‰" ]
  [ "${lines[7]}" = "ã€€ï¼ˆã‚ã‚ã‚ã‚ğŸ‘„ã‚ã‚ã‚ã‚ï¼‰" ]
  coverage "$TARGET_COMMAND" ã‚
}

@test 'å¼•æ•°ãŒ2ã¤ã®ã¨ãã¯ğŸ’©ã®ç½®æ›ã¨æ–‡è¨€å¤‰æ›´' {
  run "$TARGET_COMMAND" ã‚ ã„
  [ "$status" -eq 0 ]
  [ "${lines[0]}" = "ï¼¿äººäººäººï¼¿" ]
  [ "${lines[1]}" = "ï¼ã€€ã„ã€€ï¼œ" ]
  [ "${lines[2]}" = "ï¿£Y^Y^Y^ï¿£" ]
  [ "${lines[3]}" = "ã€€ã€€ã€€ã€€ã€€ã€€ğŸ‘‘" ]
  [ "${lines[4]}" = "ã€€ã€€ã€€ã€€ï¼ˆã‚ã‚ã‚ï¼‰" ]
  [ "${lines[5]}" = "ã€€ã€€ã€€ï¼ˆã‚ğŸ‘ã‚ğŸ‘ã‚ï¼‰" ]
  [ "${lines[6]}" = "ã€€ã€€ï¼ˆã‚ã‚ã‚ğŸ‘ƒã‚ã‚ã‚ï¼‰" ]
  [ "${lines[7]}" = "ã€€ï¼ˆã‚ã‚ã‚ã‚ğŸ‘„ã‚ã‚ã‚ã‚ï¼‰" ]
  coverage "$TARGET_COMMAND" ã‚ ã„
}

@test 'å¼•æ•°ã« /' {
  run "$TARGET_COMMAND" /
  [ "$status" -eq 0 ]
  [ "${lines[0]}" = "ï¼¿äººäººäººäººäººäººï¼¿" ]
  [ "${lines[1]}" = "ï¼ã€€çªç„¶ã®æ­»ã€€ï¼œ" ]
  [ "${lines[2]}" = "ï¿£Y^Y^Y^Y^Y^Y^ï¿£" ]
  [ "${lines[3]}" = "ã€€ã€€ã€€ã€€ã€€ã€€ğŸ‘‘" ]
  [ "${lines[4]}" = "ã€€ã€€ã€€ã€€ï¼ˆ///ï¼‰" ]
  [ "${lines[5]}" = "ã€€ã€€ã€€ï¼ˆ/ğŸ‘/ğŸ‘/ï¼‰" ]
  [ "${lines[6]}" = "ã€€ã€€ï¼ˆ///ğŸ‘ƒ///ï¼‰" ]
  [ "${lines[7]}" = "ã€€ï¼ˆ////ğŸ‘„////ï¼‰" ]
  coverage "$TARGET_COMMAND" ã‚ ã„
}

@test 'å¼•æ•°ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–‡å­—' {
  run "$TARGET_COMMAND" '\\'
  [ "$status" -eq 0 ]
  [ "${lines[0]}" = 'ï¼¿äººäººäººäººäººäººï¼¿' ]
  [ "${lines[1]}" = 'ï¼ã€€çªç„¶ã®æ­»ã€€ï¼œ' ]
  [ "${lines[2]}" = 'ï¿£Y^Y^Y^Y^Y^Y^ï¿£' ]
  [ "${lines[3]}" = 'ã€€ã€€ã€€ã€€ã€€ã€€ğŸ‘‘' ]
  [ "${lines[4]}" = 'ã€€ã€€ã€€ã€€ï¼ˆ\\\ï¼‰' ]
  [ "${lines[5]}" = 'ã€€ã€€ã€€ï¼ˆ\ğŸ‘\ğŸ‘\ï¼‰' ]
  [ "${lines[6]}" = 'ã€€ã€€ï¼ˆ\\\ğŸ‘ƒ\\\ï¼‰' ]
  [ "${lines[7]}" = 'ã€€ï¼ˆ\\\\ğŸ‘„\\\\ï¼‰' ]
  coverage "$TARGET_COMMAND" '\\'
}

@test 'ASCIIã‚³ãƒ¼ãƒ‰è¡¨33~127ã¾ã§ã§ã®ç½®æ› (ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–‡å­—ã¯é™¤å¤–)' {
  grep -o . <<< '!"#$%&'"'"'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~' | while read -r ch; do
    run "$TARGET_COMMAND" "$ch"
    [ "$status" -eq 0 ]
    [ "${lines[0]}" = "ï¼¿äººäººäººäººäººäººï¼¿" ]
    [ "${lines[1]}" = "ï¼ã€€çªç„¶ã®æ­»ã€€ï¼œ" ]
    [ "${lines[2]}" = "ï¿£Y^Y^Y^Y^Y^Y^ï¿£" ]
    [ "${lines[3]}" = "ã€€ã€€ã€€ã€€ã€€ã€€ğŸ‘‘" ]
    [ "${lines[4]}" = "ã€€ã€€ã€€ã€€ï¼ˆ$ch$ch$chï¼‰" ]
    [ "${lines[5]}" = "ã€€ã€€ã€€ï¼ˆ$chğŸ‘$chğŸ‘$chï¼‰" ]
    [ "${lines[6]}" = "ã€€ã€€ï¼ˆ$ch$ch$chğŸ‘ƒ$ch$ch$chï¼‰" ]
    [ "${lines[7]}" = "ã€€ï¼ˆ$ch$ch$ch$chğŸ‘„$ch$ch$ch$chï¼‰" ]
    coverage "$TARGET_COMMAND" "$ch"
  done
}
