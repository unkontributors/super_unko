#!/bin/bash

set -eu

readonly THIS_CMD="${0##*/}"
readonly VERSION="v1.0.0"

# Unko parts
readonly TOP="${T:-ğŸ‘‘}"
readonly UNKO="${U:-ğŸ’©}"
readonly EYE="${E:-ğŸ‘}"
readonly NOSE="${N:-ğŸ‘ƒ}"
readonly MOUSE="${M:-ğŸ‘„}"
readonly LEFT_BRACKET="${L:-ï¼ˆ}"
readonly RIGHT_BRACKET="${R:-ï¼‰}"
readonly SPACE="${S:-ã€€}"

main() {
  local height=5
  while ((0 < $#)); do
    local opt="$1"
    shift
    case "$opt" in
      -h | --help)
      usage
      return
      ;;
    -v | --version)
      echo "$VERSION"
      return
      ;;
    *)
      height="$opt"
      if ((height < 5)); then
        err "Height must be not less than 5"
        err "See help ($THIS_CMD -h)"
        return 1
      fi
      break
      ;;
    esac
  done

  print_king_unko "$height"
}

usage() {
  cat << EOS
$THIS_CMD prints a king unko.

Usage:
    $THIS_CMD [OPTIONS] NUMBER

OPTIONS:
    -h --help       Display this help and exit
    -v --version    Display this version and exit
EOS
}

## print_king_unko ã¯ã‚­ãƒ³ã‚°ã‚¦ãƒ³ã‚³ã‚’ä»»æ„ã®é«˜ã•ã§å‡ºåŠ›ã™ã‚‹ã€‚
print_king_unko() {
  local height="$1"
  print_unko "$height" | set_parts
}

## print_unko ã¯å˜ç´”ã«ã†ã‚“ã“ã‚’ä»»æ„ã®é«˜ã•ã§å‡ºåŠ›ã™ã‚‹ã€‚
## ãƒˆãƒƒãƒ—ã«ã¯ç‹å† ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã€‚
##
## ã†ã‚“ã“ã®é«˜ã•(h)ã¨hã«é”ã™ã‚‹ã¾ã§ã®å¤‰æ•°iã«å¯¾ã™ã‚‹ã†ã‚“ã“(u)ã¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°(p)ç®—å‡ºã®å¼ã¯ä»¥ä¸‹
##
## ã‚¦ãƒ³ã‚³ã®æ•°ã‚’æ±‚ã‚ã‚‹é–¢æ•° U
##   U(i)  = 2i - 1   (1 < i)
##   U'(i) = 0        (1 = i)
##
## ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã®æ•°ã‚’æ±‚ã‚ã‚‹é–¢æ•° P
##   P(h,i)  = h - (i - 1)  (1 < i)
##   P'(h,i) = h + 1        (i = 1)
print_unko() {
  local height="$1"

  for ((i=1; i<=height; i++)); do
    if ((i == 1)); then
      # i=1ã®æ™‚ã¯ç‹å† ã‚’å‡ºåŠ›
      local p=$((height + 1))
      local pad="$(repeat_str "$p" "$SPACE")"
      echo "${pad}${TOP}"
    else
      # ã†ã‚“ã“ã‚’å‡ºåŠ›
      local u=$((2 * i - 1))
      local p=$((height - (i - 1)))
      local unko="$(repeat_str "$u" "$UNKO")"
      local pad="$(repeat_str "$p" "$SPACE")"
      echo "${pad}${LEFT_BRACKET}${unko}${RIGHT_BRACKET}"
    fi
  done
}

## set_parts ã¯ç›®ã‚„å£ãªã©ã®ãƒ‘ãƒ¼ãƒ„ã‚’ã†ã‚“ã“ã«ã‚»ãƒƒãƒˆã™ã‚‹ã€‚
set_parts() {
  # NOTE:
  #   sedã®ç½®æ›å¾Œã®æ–‡å­—åˆ—ã«å¤‰æ•°ã‚’ä½¿ã†ã¨ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿æ–‡å­—ãŒä½¿ãˆãªããªã‚‹ã®ã§sedã‚’ä½¿ã‚
  #   ãªã„ã€‚
  awk \
    -v unko="$UNKO" \
    -v eye="$EYE" \
    -v nose="$NOSE" \
    -v mouse="$MOUSE" \
    'NR==3{
       r = unko unko unko unko unko
       s = unko eye unko eye unko
       gsub(r, s)
       print
     }
     NR==4{
       r = unko unko unko unko unko unko unko
       s = unko unko unko nose unko unko unko
       gsub(r, s)
       print
     }
     NR==5{
       r = unko unko unko unko unko unko unko unko unko
       s = unko unko unko unko mouse unko unko unko unko
       gsub(r, s)
       print
     }
     NR<3 || 5<NR { print }'
}

## repeat_str ã¯ä»»æ„ã®å›æ•°åˆ†ã€ä»»æ„ã®æ–‡å­—ã‚’é€£ç¶šã—ãŸ1è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‡ºåŠ›ã™ã‚‹ã€‚
repeat_str() {
  local n=$1
  local str=$2
  awk \
    -v n="$n" \
    -v str="$str" \
    'BEGIN{ for (i=0; i<n; i++) { printf "%s", str } }'
  echo
}

err() {
  echo -e "[ ERR ] $*" >&2
}

main ${1+"$@"}
exit $?
