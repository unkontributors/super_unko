#!/bin/bash

usage() {
  (
    echo "Usage: unko.toilet [ -hv ] [ -w outputwidth ]"
    echo "                   [ --crop ] [ --flip ] [ --flop ]"
    echo "                   [ --180 ] [ --left ] [ --right ]"
    echo "                   [ --border ] [ message ]"
    echo ""
    echo "  -h, --help                  ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’å‡ºåŠ›ã—ã¦çµ‚äº†ã—ã¾ã™"
    echo "  -w, --width <width, auto>   å‡ºåŠ›ã®å¹…ã§ã™ã€‚autoã‚’æŒ‡å®šã™ã‚‹ã¨ç«¯æœ«ã®å¹…ã«ãªã‚Šã¾ã™"
    echo "      --crop                  ä¸Šä¸‹å·¦å³ã®ç„¡é§„ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™"
    echo "      --flip                  æ°´å¹³æ–¹å‘ã«åè»¢ã—ã¾ã™"
    echo "      --flop                  å‚ç›´æ–¹å‘ã«åè»¢ã—ã¾ã™"
    echo "      --180                   180åº¦å›è»¢ã—ã¾ã™"
    echo "      --left                  å·¦ã¸90åº¦å›è»¢ã—ã¾ã™"
    echo "      --right                 å³ã¸90åº¦å›è»¢ã—ã¾ã™"
    echo "      --border                æ ç·šã‚’ã¤ã‘ã¾ã™"
    echo ""
  ) 1>&2
  exit 1
}

not_found() {
  echo "[ERR] $* not found  [unko.toilet]" 1>&2
  exit 1
}

append_opt() {
  toilet_opt=("${toilet_opt[@]}" "$@")
}

version() {
  echo "unko.toilet version ğŸ’©.ğŸ’©.ğŸ’© (20ğŸ’©ğŸ’©/ğŸ’©ğŸ’©/ğŸ’©ğŸ’©)"
  exit 0
}

unexpected() {
  echo "[ERR] Unexpected $1" 1>&2
  echo "" 1>&2
  usage
}

# unko.toilet ç”¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
declare -a args
declare -a toilet_opt
while (($# > 0)); do
  case "$1" in
    -*)
      # --help ã‹ -h ãŒæŒ‡å®šã•ã‚Œã¦ã„ãŸã‚‰Usageå‡ºã—ã¦çµ‚äº†
      [[ "$1" =~ ^(--help|-h)$ ]] && usage

      # --version ã‹ -v ãªã‚‰ versionæƒ…å ±ã‚’å‡ºåŠ›ã—ã¦çµ‚äº†
      [[ "$1" =~ ^(-v|--version)$ ]] && version

      : "-w|--width <width>" &&
        [[ "$1" =~ ^-(w|-width)$ ]] && {
        # widthã®å¼•æ•°ã¯int
        [[ "$2" =~ [0-9]+ ]] && {
          append_opt "--width $2"
        } || {
          # ã§ã‚‚ auto ãªã‚‰ --termwidth ã‚’æŒ‡å®šã™ã‚‹
          [[ "$2" == "auto" ]] && append_opt "--termwidth"
        } || {
          # ãƒ€ãƒ¡
          unexpected "argument $1 $2 <="
        }
        shift 2
        continue
      }

      : "Filter" &&
        [[ "$1" =~ ^--(left|right|flip|flop|180|border|crop)$ ]] && {
        append_opt "--filter ${1//--/}"
        shift
        continue
      }

      : "ãƒãƒƒãƒã—ãªã‹ã£ãŸ" && unexpected "option $1"
      ;;
    *)
      # å¼•æ•°
      args=("${args[@]}" "$1")
      shift
      ;;
  esac
done

# ç¬¬ä¸€å¼•æ•°ã«ä¸ãˆãŸæ–‡å­—ã‚’å¤‰æ›ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–‡å­—ã¯ã†ã‚“ã“
text=("${args[@]:-ã†ã‚“ã“}")

# stdinã‹ã‚‰å…¥åŠ›ã•ã‚Œã¦ã‚‹ãªã‚‰ãã£ã¡ã‚’ä½¿ã†
[ -p /dev/stdin ] && text=("$(cat -)")

# toilet ãŒãªã‹ã£ãŸã‚‰ãƒ€ãƒ¡
type toilet &> /dev/null || not_found "toilet command"

# ãƒ•ã‚©ãƒ³ãƒˆã«bigmono9ã‚’ä½¿ã†ã®ã§ç„¡ã‹ã£ãŸã‚‰ãƒ€ãƒ¡
echo | toilet -f bigmono9 &> /dev/null || not_found "bigmono9 font"

# unko.toilet
toilet "${toilet_opt[@]}" -f bigmono9 "${text[@]}" |
  # è–„ã„ã¨ã“ã‚ã¯æ¶ˆã™
  sed 's/â–‘\|â–’/ /g' |
  # ã‚¹ãƒšãƒ¼ã‚¹ä»¥å¤–ã‚’ğŸ’©ã¸
  sed 's/[^ ]/ğŸ’©/g' |
  # å¹…èª¿æ•´
  sed 's/ /  /g'
